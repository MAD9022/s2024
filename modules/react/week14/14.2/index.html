<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>14.2 Authentication | MAD9022</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="Fullstack: Frontend Development Course">
    
    <link rel="preload" href="/s2024/assets/css/0.styles.0189e570.css" as="style"><link rel="preload" href="/s2024/assets/js/app.800de6cb.js" as="script"><link rel="preload" href="/s2024/assets/js/2.65264708.js" as="script"><link rel="preload" href="/s2024/assets/js/48.85a59034.js" as="script"><link rel="preload" href="/s2024/assets/js/9.005e1e8c.js" as="script"><link rel="prefetch" href="/s2024/assets/js/10.912d3f44.js"><link rel="prefetch" href="/s2024/assets/js/11.87711128.js"><link rel="prefetch" href="/s2024/assets/js/12.1ad3b3b9.js"><link rel="prefetch" href="/s2024/assets/js/13.5c6eca3c.js"><link rel="prefetch" href="/s2024/assets/js/14.a39ca56d.js"><link rel="prefetch" href="/s2024/assets/js/15.fea1e72e.js"><link rel="prefetch" href="/s2024/assets/js/16.6b8223ef.js"><link rel="prefetch" href="/s2024/assets/js/17.db7cf2f4.js"><link rel="prefetch" href="/s2024/assets/js/18.7759db48.js"><link rel="prefetch" href="/s2024/assets/js/19.bb0f2052.js"><link rel="prefetch" href="/s2024/assets/js/20.3f3d5c16.js"><link rel="prefetch" href="/s2024/assets/js/21.23f944a3.js"><link rel="prefetch" href="/s2024/assets/js/22.32b2777d.js"><link rel="prefetch" href="/s2024/assets/js/23.aa560bd2.js"><link rel="prefetch" href="/s2024/assets/js/24.1160513f.js"><link rel="prefetch" href="/s2024/assets/js/25.257a77d2.js"><link rel="prefetch" href="/s2024/assets/js/26.9c34cefb.js"><link rel="prefetch" href="/s2024/assets/js/27.b2ff0a06.js"><link rel="prefetch" href="/s2024/assets/js/28.d09f9311.js"><link rel="prefetch" href="/s2024/assets/js/29.a0941762.js"><link rel="prefetch" href="/s2024/assets/js/3.544714c7.js"><link rel="prefetch" href="/s2024/assets/js/30.47ebd370.js"><link rel="prefetch" href="/s2024/assets/js/31.ece81fbc.js"><link rel="prefetch" href="/s2024/assets/js/32.ae206ed9.js"><link rel="prefetch" href="/s2024/assets/js/33.9514a6a6.js"><link rel="prefetch" href="/s2024/assets/js/34.583d401c.js"><link rel="prefetch" href="/s2024/assets/js/35.e656cbcf.js"><link rel="prefetch" href="/s2024/assets/js/36.cacc60df.js"><link rel="prefetch" href="/s2024/assets/js/37.1d4e63ca.js"><link rel="prefetch" href="/s2024/assets/js/38.4711b180.js"><link rel="prefetch" href="/s2024/assets/js/39.28fe2c35.js"><link rel="prefetch" href="/s2024/assets/js/4.a59aad47.js"><link rel="prefetch" href="/s2024/assets/js/40.7a728e12.js"><link rel="prefetch" href="/s2024/assets/js/41.102054ba.js"><link rel="prefetch" href="/s2024/assets/js/42.e4927ef8.js"><link rel="prefetch" href="/s2024/assets/js/43.991ea947.js"><link rel="prefetch" href="/s2024/assets/js/44.8db11b89.js"><link rel="prefetch" href="/s2024/assets/js/45.8da8f59f.js"><link rel="prefetch" href="/s2024/assets/js/46.e4ae4586.js"><link rel="prefetch" href="/s2024/assets/js/47.3a64f81f.js"><link rel="prefetch" href="/s2024/assets/js/49.d9dd3379.js"><link rel="prefetch" href="/s2024/assets/js/5.6426ebe4.js"><link rel="prefetch" href="/s2024/assets/js/50.51e2c9f2.js"><link rel="prefetch" href="/s2024/assets/js/51.bcc581ae.js"><link rel="prefetch" href="/s2024/assets/js/52.42daf800.js"><link rel="prefetch" href="/s2024/assets/js/6.2beeeb0e.js"><link rel="prefetch" href="/s2024/assets/js/7.64cbf74e.js"><link rel="prefetch" href="/s2024/assets/js/8.e15ce9b2.js">
    <link rel="stylesheet" href="/s2024/assets/css/0.styles.0189e570.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/s2024/" class="home-link router-link-active"><img src="/s2024/mad-d-logo-sm.png" alt="MAD9022" class="logo"> <span class="site-name can-hide">MAD9022</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/s2024/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/s2024/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/s2024/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hybrid</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PWA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/s2024/modules/react/week9/9.1/" class="sidebar-link">9.1: React Concepts</a></li><li><a href="/s2024/modules/react/week9/9.2/" class="sidebar-link">9.2: React Setup</a></li><li><a href="/s2024/modules/react/week10/10.1/" class="sidebar-link">10.1: JSX &amp; Components</a></li><li><a href="/s2024/modules/react/week10/10.2/" class="sidebar-link">10.2: Conditional Rendering, Data, and State</a></li><li><a href="/s2024/modules/react/week11/11.1/" class="sidebar-link">11.1: Synthetic Events and Props</a></li><li><a href="/s2024/modules/react/week11/11.2/" class="sidebar-link">11.2: Refs, Axios, Fetch, and Spinners</a></li><li><a href="/s2024/modules/react/week12/12.1/" class="sidebar-link">12.1: NextJS Intro</a></li><li><a href="/s2024/modules/react/week12/12.2/" class="sidebar-link">12.2: NextJS Routing</a></li><li><a href="/s2024/modules/react/week13/13.1/" class="sidebar-link">13.1: NextJS APIs, Actions, &amp; Middleware</a></li><li><a href="/s2024/modules/react/week13/13.2/" class="sidebar-link">13.2: Styling and Theming</a></li><li><a href="/s2024/modules/react/week14/14.1/" class="sidebar-link">14.1: TypeScript and Pair Programming</a></li><li><a href="/s2024/modules/react/week14/14.2/" aria-current="page" class="active sidebar-link">14.2: Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#authentication-in-nextjs" class="sidebar-link">Authentication in NextJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#external-authentication" class="sidebar-link">External Authentication</a></li></ul></li><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#import-reference" class="sidebar-link">Import Reference</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#middleware" class="sidebar-link">Middleware</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#extracting-user-id-from-token" class="sidebar-link">Extracting User Id From Token</a></li><li class="sidebar-sub-header"><a href="/s2024/modules/react/week14/14.2/#what-to-do-this-week" class="sidebar-link">What to do this week</a></li></ul></li><li><a href="/s2024/modules/react/week15/" class="sidebar-link">15: NextJS Project</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><header><div class="section-title blue">
    React | NextJS
  </div> <h1>14.2 Authentication</h1> <div class="underdev yes">Module Still Under Development</div></header> <h2 id="authentication-in-nextjs"><a href="#authentication-in-nextjs" class="header-anchor">#</a> Authentication in NextJS</h2> <p>There are three concepts connected to authentication.</p> <ul><li><code>Authentication</code> verifies if the user is who they say they are. It requires the user to prove their identity with something they have, such as a username and password.</li> <li><code>Session Management</code> tracks the user's state (e.g. logged in) across multiple requests.</li> <li><code>Authorization</code> decides what parts of the application the user is allowed to access.</li></ul> <p>When you are authenticating users and tracking sessions you are often using cookies to do that. Cookies can be set on either the client or server side. We will primarily try to do this on the server
side so that the cookies are set before they get to the browser.</p> <p>Cookies are set via an HTTP header - <code>set-cookie</code>. On the server-side, the cookies must be set before any content is sent to the browser. On the client-side, you can always read the cookies through
<code>document.cookie</code>. If you are setting a cookie on the client-side, then you are doing this so that it will be sent along with the next HTTP Request to the server. The same cookie will come back in the
<code>set-cookie</code> header on the next Response, unless removed or changed on the server-side.</p> <p>In NextJS, on the server-side you can set and read cookies from inside a Server Action (think <code>actions.js</code>) or inside a <code>route.js</code> file, or in the <code>middleware.js</code> file. They can only be set <strong>before</strong>
any streaming of content to the server starts.</p> <p>For the client-side, in a page.js we will just be reading cookie values like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// any page.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/headers'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookieStore <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> theme <span class="token operator">=</span> cookieStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'theme'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'...'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>In an <code>actions.js</code> Server Action function we can read AND write cookies. The <code>set()</code> and <code>delete()</code> methods do not work in a <code>page.js</code> or a component.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/actions.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/headers'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">someFunc</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//non-exported function</span>
  <span class="token comment">//read a cookie</span>
  <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'thing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// setting a basic cookie</span>
  <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'steve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// or setting one with options</span>
  <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">secure</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'kjshdfkjhsdkfhskjfhskdhfsdkhfk'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//redirect or revalidatePath</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>On the client-side, in a <code>use client</code> component, you can use plain vanilla JS and set the cookie with <code>document.cookie=&quot;name=steve;httpOnly=true;path=/;&quot;</code>. If you need the value from a cookie on a
page you can use the <code>import { cookies } from 'next/headers';</code> in your page.js file. Then you can call the <code>cookies()</code> methods:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// page.js</span>
<span class="token keyword">import</span> SomeComponent <span class="token keyword">from</span> <span class="token string">'@/app/components/SomeComponent'</span><span class="token punctuation">;</span> <span class="token comment">// a client-side component</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/headers'</span><span class="token punctuation">;</span> <span class="token comment">// SERVER SIDE ONLY</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//returns an object with that name {name:'token', value:'something'}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span>token<span class="token operator">?.</span>value<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>SomeComponent tk<span class="token operator">=</span><span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>You can use the <code>token.value</code> as the value anywhere in your page or pass the cookie object or value through props down to a client-side component.</p> <div class="custom-block tip"><p class="custom-block-title">Cookie Tips</p> <p>You can READ the value of a cookie from the request or response at any time from anywhere in your code (client or server).</p> <p><code>cookies().get('name')</code> or <code>request.cookie.get('name')</code> or <code>response.cookie.get('name')</code></p> <p>However, to SET or DELETE a cookie can only be done on the server side in a <code>route.js</code>, <code>actions.js</code>, or <code>middleware.js</code> file BEFORE the headers are streamed to the browser and the HTTP response body
is started.</p></div> <h3 id="external-authentication"><a href="#external-authentication" class="header-anchor">#</a> External Authentication</h3> <p>When working with Google Auth, like in your final project api, we redirect the user to the Google login page. We send a <code>redirect_url</code> through the querystring. This way, after the Authentication is
completed, Google can send the user to the <code>redirect_url</code> value. This <code>redirect_url</code> will be the home page for your website.</p> <p>After a successful login, when Google redirects the user, they will also send a JWT token through the querystring.</p> <p>In your final project you will get that token from the querystring back in the NextJS website. The token can be set as a cookie or saved on the clientside in sessionStorage. To access the token from
sessionStorage, it means this can only be done from inside a <code>use client</code> component. If a cookie is set with the token then it can be passed with every request navigation from page to page within the
website.</p> <p>To use the token in calls to your API on the Render site, you will need to place the token in the HTTP Request headers.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://www.example.com/api'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">'khsdkfhsdjfskhfskdhfkjshfh'</span><span class="token punctuation">;</span>

<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">accept</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">//to send the JWT token to the</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>You can review the videos about <a href="https://mad9022.github.io/W2024/modules/pwas/week5/5.1/#authentication-and-jwt" target="_blank" rel="noopener noreferrer">JWT Authentication in Module 5.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="custom-block tip"><p class="custom-block-title">HTTP Request Body</p> <p>If you are making a <code>GET</code> request, you <strong>cannot</strong> add a <code>body</code> in the fetch.</p> <p>If you are adding a <code>body</code> to a <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, or <code>DELETE</code>, then it can be a <code>FormData</code> object, a JSON string, or a plain string. <code>FormData</code> objects can include <code>File</code> objects.</p></div> <h2 id="import-reference"><a href="#import-reference" class="header-anchor">#</a> Import Reference</h2> <p>With NextJS there is a long list of methods that you will be importing from lots of different packages. So, this is a quick reference list.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//server side imports</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span><span class="token punctuation">;</span> <span class="token comment">// inside route.js, page.js, and actions.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> revalidatePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/cache'</span><span class="token punctuation">;</span> <span class="token comment">// inside route.js and actions.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/headers'</span><span class="token punctuation">;</span> <span class="token comment">// inside page.js, route.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/server'</span><span class="token punctuation">;</span> <span class="token comment">//inside actions.js and middleware.js</span>

<span class="token comment">// used with 'use client' in components</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span><span class="token punctuation">;</span>

<span class="token comment">// in either page.js or any components</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'next/link'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h2> <p>In a Next.js app we can create middleware functions just like with Express. You need to create a <code>middleware.js</code> file and place it at the top of the project, at the same level as the <code>app</code> folder (not
inside it).</p> <p>The <code>middleware.js</code> will have one exported function and an exported <code>config</code> object. The <code>config</code> object contains an array of all the routes which you want to have the middleware function run first.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//middleware.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/server'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//request.nextUrl - same as new URL(request.url)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>nextUrl<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//you can get/set/delete cookies or headers or redirect</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>nextUrl<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/secret'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//you can get/set/delete cookies or headers or redirect</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>nextUrl<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/logout'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//you can get/set/delete cookies or headers or redirect</span>
    <span class="token comment">//maybe redirect based on something;</span>
    <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'/new'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">matcher</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'/secret'</span><span class="token punctuation">,</span> <span class="token string">'/anyone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//without config the middleware function runs for every page</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>Inside the middleware function you can handle any route that you want. You can examine the request object that is being passed through the middleware function by using <code>request.nextUrl</code>. The
<code>request.nextUrl</code> object is the same as turning the url from the request into a <code>new URL</code> object.</p> <p>With the <code>request.nextUrl</code> you can read the <code>.pathname</code>, <code>.basePath</code>, <code>.cookies</code>, <code>.searchParams</code>, or <code>.headers</code> properties. From those properties you can make decisions about whether you need edit
cookies or headers or if you want to do a redirect to a whole new url. <a href="https://nextjs.org/docs/app/api-reference/functions/next-request#nexturl" target="_blank" rel="noopener noreferrer">newUrl reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Once you have a <code>middleware.js</code> file and function, a good way to stay organized is through calling server-side functions in your <code>actions.js</code> file.</p> <p>Here are a couple repos that you can clone and run from different instances of VS Code. One is a server that acts like a fake Google Auth endpoint. The other is the website that manages sessions
through JWT-ish tokens.</p> <p><a href="https://github.com/prof3ssorSt3v3/fake-google-auth" target="_blank" rel="noopener noreferrer">Fake Google Auth endpoint<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/prof3ssorSt3v3/improved-fortnight" target="_blank" rel="noopener noreferrer">Website with Auth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="extracting-user-id-from-token"><a href="#extracting-user-id-from-token" class="header-anchor">#</a> Extracting User Id From Token</h2> <p>The JWT token is a base-64 string that contains information about the user.</p> <p>We are saving this token as a cookie in our application. This let's us figure out whether or not the user has logged in. Whether or not the token is valid is determined on the server before any data
gets accessed.</p> <p>On the client-side there will be times when you want to find the actual user id so you can include it as part of a fetch call to the server.</p> <p>The JavaScript function to convert from a base-64 string back to a basic utf-8 string is <code>atob()</code>. The token is made up of three parts separated by a period. The middle part is the object that
includes an <code>id</code> property. The value returned from the <code>atob</code> function is a JSON string. This is just like the result from a fetch to an API. You will need to convert the value from a string into a JS
object to get the <code>id</code> value.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token operator">?.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// the actual id from the logged in user</span>

  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>The user object that you extract from the token will look something like this:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6611d3ef19ce24e6e7ce03bd&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1712807730</span><span class="token punctuation">,</span> <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1713412530</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Convert that to an object, then you will have the <code>id</code> to pass to any fetch call.</p> <h2 id="what-to-do-this-week"><a href="#what-to-do-this-week" class="header-anchor">#</a> What to do this week</h2> <div class="custom-block warning"><p class="custom-block-title">TODO Things to do before next week.</p> <ul><li>Read all the content from <code>Modules 14.1 and 14.2</code>.</li> <li>Work on your <a href="/s2024/assignments/projects/">Final Project</a> with your partner.</li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/16/2024, 3:45:15 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/s2024/modules/react/week14/14.1/" class="prev">
        14.1: TypeScript and Pair Programming
      </a></span> <span class="next"><a href="/s2024/modules/react/week15/">
        15: NextJS Project
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/s2024/assets/js/app.800de6cb.js" defer></script><script src="/s2024/assets/js/2.65264708.js" defer></script><script src="/s2024/assets/js/48.85a59034.js" defer></script><script src="/s2024/assets/js/9.005e1e8c.js" defer></script>
  </body>
</html>
